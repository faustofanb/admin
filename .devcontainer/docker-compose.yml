version: '3.8'
services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
    volumes:
      - ../..:/workspaces:cached
      - /var/run/docker.sock:/var/run/docker.sock
    command: sleep infinity

  postgresql:
    image: postgres:16-alpine
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # Apache Pulsar (Standalone mode with all components)
  pulsar:
    image: apachepulsar/pulsar:4.1.2
    command: bin/pulsar standalone
    ports:
      - "6650:6650"   # Pulsar broker port
      - "8080:8080"   # Pulsar web service port (映射到8085避免冲突)
      - "8000:8000"
    environment:
      - PULSAR_MEM=-Xms512m -Xmx512m
    volumes:
      - pulsar-data:/pulsar/data
      - pulsar-conf:/pulsar/conf

  # Pulsar Manager (Dashboard)
  pulsar-manager:
    image: apachepulsar/pulsar-manager:v0.4.0
    ports:
      - "9527:9527"   # Pulsar Manager web UI
      - "7750:7750"   # Pulsar Manager backend
    environment:
      - SPRING_CONFIGURATION_FILE=/pulsar-manager/pulsar-manager/application.properties
    depends_on:
      - pulsar

  # PowerJob Server
  powerjob-server:
    image: powerjob/powerjob-server:latest
    ports:
      - "7700:7700"
    environment:
      - JVMOPTIONS=-Xmx512m
      - PARAMS=--spring.profiles.active=product --spring.datasource.core.jdbc-url=jdbc:postgresql://postgresql:5432/powerjob_product --spring.datasource.core.username=admin --spring.datasource.core.password=password --spring.datasource.core.driver-class-name=org.postgresql.Driver
    depends_on:
      - postgresql

  # RustFS (S3 Compatible Object Storage)
#  rustfs:
#    image: rustfs/rustfs:latest
#    ports:
#      - 9000:9000 # S3 API
#      - 9001:9001 # Console
#    volumes:
#      - rustfs-data:/data
#    environment:
#      - RUSTFS_ACCESS_KEY=rustfsadmin
#      - RUSTFS_SECRET_KEY=rustfsadmin
#
#  # Loki (Log Aggregation)
#  loki:
#    image: grafana/loki:2.9.2
#    ports:
#      - 3100:3100
#    command: -config.file=/etc/loki/local-config.yaml
#
#  # Promtail (Log Collector)
#  promtail:
#    image: grafana/promtail:2.9.2
#    volumes:
#      - /var/log:/var/log
#    command: -config.file=/etc/promtail/config.yml
#
#  # Grafana (Visualization)
#  grafana:
#    image: grafana/grafana:latest
#    ports:
#      - 3000:3000
#    environment:
#      - GF_SECURITY_ADMIN_PASSWORD=password
#    depends_on:
#      - loki
#      - prometheus
#
#  # Prometheus (Metrics)
#  prometheus:
#    image: prom/prometheus:latest
#    ports:
#      - 9090:9090
#    command: --config.file=/etc/prometheus/prometheus.yml

volumes:
  postgres-data:
  redis-data:
  rustfs-data:
  pulsar-data:
  pulsar-conf:
